<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.petadoption.mapper.PetMapper">

    <!-- 结果映射 -->
    <resultMap id="PetResultMap" type="Pet">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="species" column="species"/>
        <result property="breed" column="breed"/>
        <result property="age" column="age"/>
        <result property="gender" column="gender"/>
        <result property="weight" column="weight"/>
        <result property="color" column="color"/>
        <result property="personality" column="personality"/>
        <result property="isSterilized" column="is_sterilized"/>
        <result property="status" column="status"/>
        <result property="shelterId" column="shelter_id"/>
        <result property="imageUrl" column="image_url"/>
        <result property="viewCount" column="view_count"/>
        <result property="applyCount" column="apply_count"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <!-- 通用字段 -->
    <sql id="Base_Column_List">
        id, name, species, breed, age, gender, weight, color, personality, 
        is_sterilized, status, shelter_id, image_url, view_count, apply_count, create_time
    </sql>

    <!-- 根据ID查询 -->
    <select id="selectById" parameterType="int" resultMap="PetResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_pet
        WHERE id = #{id}
    </select>

    <!-- 插入宠物 -->
    <insert id="insert" parameterType="Pet" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_pet (name, species, breed, age, gender, weight, color, personality, 
                           is_sterilized, status, shelter_id, image_url, view_count, apply_count)
        VALUES (#{name}, #{species}, #{breed}, #{age}, #{gender}, #{weight}, #{color}, #{personality}, 
                #{isSterilized}, #{status}, #{shelterId}, #{imageUrl}, #{viewCount}, #{applyCount})
    </insert>

    <!-- 更新宠物 -->
    <update id="update" parameterType="Pet">
        UPDATE t_pet
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="species != null">species = #{species},</if>
            <if test="breed != null">breed = #{breed},</if>
            <if test="age != null">age = #{age},</if>
            <if test="gender != null">gender = #{gender},</if>
            <if test="weight != null">weight = #{weight},</if>
            <if test="color != null">color = #{color},</if>
            <if test="personality != null">personality = #{personality},</if>
            <if test="isSterilized != null">is_sterilized = #{isSterilized},</if>
            <if test="status != null">status = #{status},</if>
            <if test="imageUrl != null">image_url = #{imageUrl},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 更新状态 -->
    <update id="updateStatus">
        UPDATE t_pet
        SET status = #{status}
        WHERE id = #{id}
    </update>
    
    <!-- 删除宠物 -->
    <delete id="deleteById" parameterType="int">
        DELETE FROM t_pet WHERE id = #{id}
    </delete>
    
    <!-- 增加浏览次数 -->
    <update id="incrementViewCount">
        UPDATE t_pet
        SET view_count = view_count + 1
        WHERE id = #{id}
    </update>
    
    <!-- 增加申请次数 -->
    <update id="incrementApplyCount">
        UPDATE t_pet
        SET apply_count = apply_count + 1
        WHERE id = #{id}
    </update>

    <!-- 分页查询 -->
    <select id="selectByPage" resultMap="PetResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_pet
        <where>
            <if test="species != null and species != ''">
                AND species = #{species}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%')
                     OR breed LIKE CONCAT('%', #{keyword}, '%')
                     OR color LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY create_time DESC
    </select>
    
    <!-- 收容所查询 -->
    <select id="selectByShelter" resultMap="PetResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_pet
        <where>
            shelter_id = #{shelterId}
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%')
                     OR breed LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

</mapper>
